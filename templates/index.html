<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïì∞Îü¨Ïßê Í∞êÏßÄ ÏãúÏä§ÌÖú</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        #video-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        #video {
            display: none;
        }

        #canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #processed-video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 100;
        }

        #status.connected {
            color: #4CAF50;
        }

        #status.disconnected {
            color: #f44336;
        }

        #status.warning {
            color: #ff9800;
        }

        #camera-permission-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        #camera-permission-btn:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        #camera-permission-btn:active {
            transform: translate(-50%, -50%) scale(0.98);
        }

        #camera-permission-btn.hidden {
            display: none;
        }

        .warning-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.9);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            display: none;
            z-index: 100;
            animation: pulse 1s infinite;
        }

        .warning-indicator.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 100;
            max-width: 300px;
        }

        .info-panel h3 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .info-panel p {
            margin: 5px 0;
            line-height: 1.5;
        }

        audio {
            display: none;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            text-align: center;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="video-container">
            <div id="status" class="disconnected">Ïó∞Í≤∞ Ï§ë...</div>
            
            <button id="camera-permission-btn">Ïπ¥Î©îÎùº ÏãúÏûëÌïòÍ∏∞</button>
            
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Ï≤òÎ¶¨ Ï§ë...</p>
            </div>

            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <img id="processed-video" alt="Processed Video Stream">

            <div class="warning-indicator" id="warning-indicator">
                ‚ö†Ô∏è Ïì∞Îü¨Ïßê Í∞êÏßÄ! ‚ö†Ô∏è
            </div>

            <div class="info-panel">
                <h3>ÏãúÏä§ÌÖú Ï†ïÎ≥¥</h3>
                <p>üìπ ÏÉÅÌÉú: <span id="camera-status">ÎåÄÍ∏∞ Ï§ë</span></p>
                <p>üîç Í∞êÏßÄ: <span id="detection-status">Ï†ïÏÉÅ</span></p>
                <p>‚è±Ô∏è FPS: <span id="fps">0</span></p>
            </div>
        </div>
    </div>

    <!-- Í≤ΩÍ≥†Ïùå -->
    <audio id="warning-audio" loop>
        <source src="/static/siren.mp3" type="audio/mpeg">
    </audio>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const processedVideo = document.getElementById('processed-video');
        const status = document.getElementById('status');
        const warningIndicator = document.getElementById('warning-indicator');
        const warningAudio = document.getElementById('warning-audio');
        const cameraBtn = document.getElementById('camera-permission-btn');
        const loading = document.getElementById('loading');
        const cameraStatus = document.getElementById('camera-status');
        const detectionStatus = document.getElementById('detection-status');
        const fpsDisplay = document.getElementById('fps');

        let socket = null;
        let isStreaming = false;
        let frameCount = 0;
        let lastFpsTime = Date.now();
        let currentFps = 0;
        let warningBlinkInterval = null;
        let isWarningActive = false;
        let isCameraReady = false;

        // Socket.IO Ïó∞Í≤∞
        function connectSocket() {
            socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

            socket.on('connect', function() {
                console.log('ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®');
                status.textContent = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®';
                status.className = 'connected';
            });

            socket.on('disconnect', function() {
                console.log('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ìï¥Ï†úÎê®');
                status.textContent = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ìï¥Ï†úÎê®';
                status.className = 'disconnected';
            });

            socket.on('processed_frame', function(data) {
                // Ï≤òÎ¶¨Îêú ÌîÑÎ†àÏûÑ ÌëúÏãú
                processedVideo.src = data.frame;
                
                // Ïì∞Îü¨Ïßê Í∞êÏßÄ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                if (data.is_fall) {
                    if (!isWarningActive) {
                        activateWarning();
                    }
                    detectionStatus.textContent = '‚ö†Ô∏è Ïì∞Îü¨Ïßê Í∞êÏßÄ!';
                    detectionStatus.style.color = '#ff4444';
                } else {
                    if (isWarningActive) {
                        deactivateWarning();
                    }
                    detectionStatus.textContent = 'Ï†ïÏÉÅ';
                    detectionStatus.style.color = '#4CAF50';
                }

                // FPS Í≥ÑÏÇ∞
                frameCount++;
                const now = Date.now();
                if (now - lastFpsTime >= 1000) {
                    currentFps = frameCount;
                    fpsDisplay.textContent = currentFps;
                    frameCount = 0;
                    lastFpsTime = now;
                }
            });
        }

        // Ïπ¥Î©îÎùº ÏãúÏûë
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 480 },
                        height: { ideal: 360 },
                        facingMode: 'user'
                    },
                    audio: false 
                });
                
                video.srcObject = stream;
                
                video.onloadedmetadata = function() {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    isCameraReady = true;
                    cameraBtn.classList.add('hidden');
                    loading.style.display = 'none';
                    cameraStatus.textContent = 'ÌôúÏÑ±';
                    cameraStatus.style.color = '#4CAF50';
                    
                    // ÌîÑÎ†àÏûÑ Ï†ÑÏÜ° ÏãúÏûë
                    isStreaming = true;
                    sendFrames();
                };

            } catch (err) {
                console.error('Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïò§Î•ò:', err);
                alert('Ïπ¥Î©îÎùº Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.\nÎ∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú Ïπ¥Î©îÎùº Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
                cameraBtn.classList.remove('hidden');
                loading.style.display = 'none';
                status.textContent = 'Ïπ¥Î©îÎùº Í∂åÌïú Í±∞Î∂ÄÎê®';
                status.className = 'warning';
            }
        }

        // ÌîÑÎ†àÏûÑ Ï†ÑÏÜ°
        let isProcessing = false;
        function sendFrames() {
            if (!isStreaming || !isCameraReady || !socket || isProcessing) {
                if (isStreaming && isCameraReady) {
                    setTimeout(sendFrames, 200);
                }
                return;
            }

            isProcessing = true;
            
            // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏµúÏ†ÅÌôî (480px ÏµúÎåÄ - Îçî ÏûëÍ≤å)
            let targetWidth = Math.min(video.videoWidth, 480);
            let targetHeight = Math.min(video.videoHeight, 360);
            
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            
            ctx.drawImage(video, 0, 0, targetWidth, targetHeight);
            const frameData = canvas.toDataURL('image/jpeg', 0.6);
            
            socket.emit('video_frame', { frame: frameData });

            // Îã§Ïùå ÌîÑÎ†àÏûÑ ÏöîÏ≤≠ (ÏïΩ 5fps - Î©îÎ™®Î¶¨ ÏµúÏ†ÅÌôî)
            setTimeout(() => {
                isProcessing = false;
                sendFrames();
            }, 200);
        }

        // Í≤ΩÍ≥† ÌôúÏÑ±Ìôî
        function activateWarning() {
            isWarningActive = true;
            warningIndicator.classList.add('active');
            
            // Í≤ΩÍ≥†Ïùå Ïû¨ÏÉù
            warningAudio.play().catch(err => {
                console.log('Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïò§Î•ò:', err);
            });

            // WARNING ÌÖçÏä§Ìä∏ ÍπúÎπ°ÏûÑ (500ms Í∞ÑÍ≤©)
            let blinkState = false;
            warningBlinkInterval = setInterval(() => {
                blinkState = !blinkState;
                socket.emit('toggle_warning', { show: blinkState });
            }, 500);
        }

        // Í≤ΩÍ≥† ÎπÑÌôúÏÑ±Ìôî
        function deactivateWarning() {
            isWarningActive = false;
            warningIndicator.classList.remove('active');
            
            // Í≤ΩÍ≥†Ïùå Ï†ïÏßÄ
            warningAudio.pause();
            warningAudio.currentTime = 0;

            // ÍπúÎπ°ÏûÑ Ï§ëÏßÄ
            if (warningBlinkInterval) {
                clearInterval(warningBlinkInterval);
                warningBlinkInterval = null;
            }
            
            socket.emit('toggle_warning', { show: false });
        }

        // Ïπ¥Î©îÎùº Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        cameraBtn.addEventListener('click', function() {
            cameraBtn.classList.add('hidden');
            loading.style.display = 'block';
            startCamera();
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÜåÏºì Ïó∞Í≤∞
        window.addEventListener('load', function() {
            connectSocket();
        });

        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', function() {
            isStreaming = false;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
